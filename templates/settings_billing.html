{% extends "base.html" %}
{% set lang = request.state.lang if request and request.state else 'de' %}
{% if lang == 'en' %}
  {% set b_title = 'ğŸ’³ Subscription & Billing â€“ Ouhud QR' %}
  {% set b_h1 = 'ğŸ’³ Subscription & Billing' %}
  {% set b_sub = 'Manage your plan, payments, and full invoice history.' %}
  {% set b_active = 'Active' %}
  {% set b_cancelled = 'Cancelled' %}
  {% set b_pending = 'In progress' %}
  {% set b_success = 'âœ… Payment successful - your plan has been updated.' %}
  {% set b_sync_ok = 'â„¹ï¸ Plan synchronization completed.' %}
  {% set b_sync_wait = 'âš ï¸ Payment succeeded, plan sync continues in the background via webhook.' %}
  {% set b_pay_cancelled = 'âŒ Payment cancelled.' %}
  {% set b_abo_cancelled = 'â„¹ï¸ Your subscription has been cancelled.' %}
  {% set b_owner_exempt = 'â„¹ï¸ Owner account: billing is exempt.' %}
  {% set b_current = 'Your current plan' %}
  {% set b_free = 'Free until' %}
  {% set b_next = 'Next billing:' %}
  {% set b_pay_now = 'Pay now' %}
  {% set b_upgrade = 'Upgrade / Downgrade' %}
  {% set b_cancel_btn = 'Cancel subscription' %}
  {% set b_owner_badge = 'Owner access (no billing)' %}
  {% set b_plans = 'Plans' %}
  {% set b_plans_sub = 'Choose the plan that fits your project.' %}
  {% set b_start = 'Start now' %}
  {% set b_contact = 'Contact sales' %}
  {% set b_invoices = 'Invoices' %}
  {% set th_date = 'ğŸ“… Date' %}
  {% set th_desc = 'ğŸ§¾ Description' %}
  {% set th_amount = 'ğŸ’¶ Amount' %}
  {% set th_status = 'ğŸ“Œ Status' %}
  {% set th_pdf = 'â¬‡ï¸ PDF' %}
  {% set st_paid = 'Paid' %}
  {% set st_open = 'Open' %}
  {% set b_no_invoices = 'No invoices available.' %}
  {% set enterprise_price = 'On request' %}
  {% set feat_basic = ['ğŸ“¦ Up to 10 QR codes', 'ğŸ 1 month free', 'ğŸ”’ No API access'] %}
  {% set feat_pro = ['ğŸ“¦ Up to 50 QR codes', 'ğŸ 3 months free', 'ğŸ”’ No API access'] %}
  {% set feat_business = ['ğŸ“¦ Up to 250 QR codes', 'ğŸ 6 months free', 'ğŸ”— API access included'] %}
  {% set feat_enterprise = ['ğŸ“¦ Up to 999999 QR codes', 'ğŸ”— API access included'] %}
{% elif lang == 'ar' %}
  {% set b_title = 'ğŸ’³ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙˆØ§Ù„ÙÙˆØ§ØªÙŠØ± â€“ Ouhud QR' %}
  {% set b_h1 = 'ğŸ’³ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙˆØ§Ù„ÙÙˆØ§ØªÙŠØ±' %}
  {% set b_sub = 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø§Ù‚Ø© ÙˆØ§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª ÙˆØ³Ø¬Ù„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„ÙƒØ§Ù…Ù„.' %}
  {% set b_active = 'Ù†Ø´Ø·' %}
  {% set b_cancelled = 'Ù…Ù„ØºÙ‰' %}
  {% set b_pending = 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©' %}
  {% set b_success = 'âœ… ØªÙ…Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­ - ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø§Ù‚Ø©.' %}
  {% set b_sync_ok = 'â„¹ï¸ Ø§ÙƒØªÙ…Ù„Øª Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨Ø§Ù‚Ø©.' %}
  {% set b_sync_wait = 'âš ï¸ Ø§Ù„Ø¯ÙØ¹ Ù†Ø§Ø¬Ø­ØŒ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨Ø§Ù‚Ø© Ù…Ø³ØªÙ…Ø±Ø© ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¹Ø¨Ø± Webhook.' %}
  {% set b_pay_cancelled = 'âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¯ÙØ¹.' %}
  {% set b_abo_cancelled = 'â„¹ï¸ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ø´ØªØ±Ø§ÙƒÙƒ.' %}
  {% set b_owner_exempt = 'â„¹ï¸ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø§Ù„Ùƒ: Ø¨Ø¯ÙˆÙ† ÙÙˆØªØ±Ø©.' %}
  {% set b_current = 'Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©' %}
  {% set b_free = 'Ù…Ø¬Ø§Ù†ÙŠ Ø­ØªÙ‰' %}
  {% set b_next = 'Ø§Ù„ÙÙˆØªØ±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©:' %}
  {% set b_pay_now = 'Ø§Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†' %}
  {% set b_upgrade = 'ØªØ±Ù‚ÙŠØ© / ØªØ®ÙÙŠØ¶' %}
  {% set b_cancel_btn = 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ' %}
  {% set b_owner_badge = 'ØµÙ„Ø§Ø­ÙŠØ© Ù…Ø§Ù„Ùƒ (Ø¨Ø¯ÙˆÙ† ÙÙˆØªØ±Ø©)' %}
  {% set b_plans = 'Ø§Ù„Ø¨Ø§Ù‚Ø§Øª' %}
  {% set b_plans_sub = 'Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù…Ø´Ø±ÙˆØ¹Ùƒ.' %}
  {% set b_start = 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†' %}
  {% set b_contact = 'ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª' %}
  {% set b_invoices = 'Ø§Ù„ÙÙˆØ§ØªÙŠØ±' %}
  {% set th_date = 'ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®' %}
  {% set th_desc = 'ğŸ§¾ Ø§Ù„ÙˆØµÙ' %}
  {% set th_amount = 'ğŸ’¶ Ø§Ù„Ù…Ø¨Ù„Øº' %}
  {% set th_status = 'ğŸ“Œ Ø§Ù„Ø­Ø§Ù„Ø©' %}
  {% set th_pdf = 'â¬‡ï¸ PDF' %}
  {% set st_paid = 'Ù…Ø¯ÙÙˆØ¹' %}
  {% set st_open = 'Ù…ÙØªÙˆØ­' %}
  {% set b_no_invoices = 'Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ±.' %}
  {% set enterprise_price = 'Ø­Ø³Ø¨ Ø§Ù„Ø·Ù„Ø¨' %}
  {% set feat_basic = ['ğŸ“¦ Ø­ØªÙ‰ 10 Ø±Ù…ÙˆØ² QR', 'ğŸ Ø´Ù‡Ø± Ù…Ø¬Ø§Ù†ÙŠ', 'ğŸ”’ Ø¨Ø¯ÙˆÙ† API'] %}
  {% set feat_pro = ['ğŸ“¦ Ø­ØªÙ‰ 50 Ø±Ù…Ø² QR', 'ğŸ 3 Ø£Ø´Ù‡Ø± Ù…Ø¬Ø§Ù†ÙŠØ©', 'ğŸ”’ Ø¨Ø¯ÙˆÙ† API'] %}
  {% set feat_business = ['ğŸ“¦ Ø­ØªÙ‰ 250 Ø±Ù…Ø² QR', 'ğŸ 6 Ø£Ø´Ù‡Ø± Ù…Ø¬Ø§Ù†ÙŠØ©', 'ğŸ”— API Ù…ØªØ§Ø­'] %}
  {% set feat_enterprise = ['ğŸ“¦ Ø­ØªÙ‰ 999999 Ø±Ù…Ø² QR', 'ğŸ”— API Ù…ØªØ§Ø­'] %}
{% else %}
  {% set b_title = 'ğŸ’³ Abonnement & Rechnungen â€“ Ouhud QR' %}
  {% set b_h1 = 'ğŸ’³ Abonnement & Rechnungen' %}
  {% set b_sub = 'Verwalte deinen Tarif, Zahlungen und deinen kompletten Rechnungsverlauf.' %}
  {% set b_active = 'Aktiv' %}
  {% set b_cancelled = 'GekÃ¼ndigt' %}
  {% set b_pending = 'In Bearbeitung' %}
  {% set b_success = 'âœ… Zahlung erfolgreich â€“ dein Plan wurde aktualisiert.' %}
  {% set b_sync_ok = 'â„¹ï¸ Plan-Synchronisierung erfolgreich abgeschlossen.' %}
  {% set b_sync_wait = 'âš ï¸ Zahlung ist erfolgreich, Plan-Sync lÃ¤uft im Hintergrund per Webhook.' %}
  {% set b_pay_cancelled = 'âŒ Zahlung abgebrochen.' %}
  {% set b_abo_cancelled = 'â„¹ï¸ Dein Abonnement wurde beendet.' %}
  {% set b_owner_exempt = 'â„¹ï¸ Owner-Konto: keine Abrechnung aktiv.' %}
  {% set b_current = 'Dein aktueller Plan' %}
  {% set b_free = 'Kostenlos bis' %}
  {% set b_next = 'NÃ¤chste Abrechnung:' %}
  {% set b_pay_now = 'Jetzt bezahlen' %}
  {% set b_upgrade = 'Upgrade / Downgrade' %}
  {% set b_cancel_btn = 'Abo kÃ¼ndigen' %}
  {% set b_owner_badge = 'Owner-Zugang (ohne Abrechnung)' %}
  {% set b_plans = 'Tarife' %}
  {% set b_plans_sub = 'WÃ¤hle den Tarif, der zu deinem Projekt passt.' %}
  {% set b_start = 'Jetzt starten' %}
  {% set b_contact = 'Kontakt aufnehmen' %}
  {% set b_invoices = 'Rechnungen' %}
  {% set th_date = 'ğŸ“… Datum' %}
  {% set th_desc = 'ğŸ§¾ Beschreibung' %}
  {% set th_amount = 'ğŸ’¶ Betrag' %}
  {% set th_status = 'ğŸ“Œ Status' %}
  {% set th_pdf = 'â¬‡ï¸ PDF' %}
  {% set st_paid = 'Bezahlt' %}
  {% set st_open = 'Offen' %}
  {% set b_no_invoices = 'Keine Rechnungen vorhanden.' %}
  {% set enterprise_price = 'Auf Anfrage' %}
  {% set feat_basic = ['ğŸ“¦ Bis zu 10 QR-Codes', 'ğŸ 1 Monat kostenlos', 'ğŸ”’ Kein API-Zugang'] %}
  {% set feat_pro = ['ğŸ“¦ Bis zu 50 QR-Codes', 'ğŸ 3 Monate kostenlos', 'ğŸ”’ Kein API-Zugang'] %}
  {% set feat_business = ['ğŸ“¦ Bis zu 250 QR-Codes', 'ğŸ 6 Monate kostenlos', 'ğŸ”— API-Zugang inklusive'] %}
  {% set feat_enterprise = ['ğŸ“¦ Bis zu 999999 QR-Codes', 'ğŸ”— API-Zugang inklusive'] %}
{% endif %}
{% block title %}{{ b_title }}{% endblock %}

{% block content %}
<section class="qr-generator billing-generator">
  <h1>{{ b_h1 }}</h1>
  <p class="subtitle">{{ b_sub }}</p>

  {% if status == "Aktiv" %}
    <div class="status-badge success">{{ b_active }}</div>
  {% elif status == "GekÃ¼ndigt" %}
    <div class="status-badge danger">{{ b_cancelled }}</div>
  {% else %}
    <div class="status-badge warn">{{ b_pending }}</div>
  {% endif %}

  {% if request.query_params.get('status') == 'success' %}
    <div class="alert success">{{ b_success }}</div>
    {% if request.query_params.get('sync') == '1' %}<div class="alert info">{{ b_sync_ok }}</div>{% elif request.query_params.get('sync') == '0' %}<div class="alert warn">{{ b_sync_wait }}</div>{% endif %}
  {% elif request.query_params.get('status') == 'cancelled' %}
    <div class="alert error">{{ b_pay_cancelled }}</div>
  {% elif request.query_params.get('msg') == 'cancelled' %}
    <div class="alert info">{{ b_abo_cancelled }}</div>
  {% elif request.query_params.get('msg') == 'owner_exempt' %}
    <div class="alert info">{{ b_owner_exempt }}</div>
  {% endif %}

  <div class="qr-form">
    <h2 class="form-title">{{ b_current }}</h2>
    <div class="plan-wrapper">
      <div>
        <h3 class="plan-name">{{ plan }}</h3>
        <p class="plan-price">{{ price }}</p>
        {% if trial_end %}<p class="info-line highlight">{{ b_free }} <strong>{{ trial_end }}</strong></p>{% endif %}
        <p class="info-line">{{ b_next }} <strong>{{ next_billing or "â€“" }}</strong></p>
      </div>
      <div class="btn-column">
        {% if payment_required and not billing_exempt %}<a class="btn-primary small w-full" href="/billing/pay-now">{{ b_pay_now }}</a>{% endif %}
        {% if plan != "Enterprise" and not billing_exempt %}<a class="btn-outline-success small w-full" href="/billing/upgrade/{{ plan|lower }}">{{ b_upgrade }}</a>{% endif %}
        {% if status == "Aktiv" and not billing_exempt %}<a class="btn-outline-danger small w-full" href="/billing/cancel">{{ b_cancel_btn }}</a>{% endif %}
        {% if billing_exempt %}<span class="badge success">{{ b_owner_badge }}</span>{% endif %}
      </div>
    </div>
  </div>

  <div class="qr-form">
    <h2 class="form-title">{{ b_plans }}</h2>
    <p class="info-text">{{ b_plans_sub }}</p>

    <div class="tariff-grid">
      <div class="tariff-card {% if plan=='Basic' %}active{% endif %}">
        <h3>Basic</h3><p class="price">4.99 â‚¬/Monat</p>
        <ul><li>{{ feat_basic[0] }}</li><li>{{ feat_basic[1] }}</li><li>{{ feat_basic[2] }}</li></ul>
        {% if not billing_exempt %}<a href="/billing/upgrade/basic" class="btn-primary w-full small">{{ b_start }}</a>{% endif %}
      </div>

      <div class="tariff-card {% if plan=='Pro' %}active{% endif %}">
        <h3>Pro</h3><p class="price">14.99 â‚¬/Monat</p>
        <ul><li>{{ feat_pro[0] }}</li><li>{{ feat_pro[1] }}</li><li>{{ feat_pro[2] }}</li></ul>
        {% if not billing_exempt %}<a href="/billing/upgrade/pro" class="btn-primary w-full small">{{ b_start }}</a>{% endif %}
      </div>

      <div class="tariff-card {% if plan=='Business' %}active{% endif %}">
        <h3>Business</h3><p class="price">29.99 â‚¬/Monat</p>
        <ul><li>{{ feat_business[0] }}</li><li>{{ feat_business[1] }}</li><li>{{ feat_business[2] }}</li></ul>
        {% if not billing_exempt %}<a href="/billing/upgrade/business" class="btn-primary w-full small">{{ b_start }}</a>{% endif %}
      </div>

      <div class="tariff-card">
        <h3>Enterprise</h3><p class="price accent">{{ enterprise_price }}</p>
        <ul><li>{{ feat_enterprise[0] }}</li><li>{{ feat_enterprise[1] }}</li></ul>
        {% if not billing_exempt %}<a href="/contact?topic=enterprise" class="btn-primary w-full small">{{ b_contact }}</a>{% endif %}
      </div>
    </div>
  </div>

  <div class="qr-form">
    <h2 class="form-title">{{ b_invoices }}</h2>
    {% if invoices %}
    <div class="overflow-x-auto">
      <table class="billing-table">
        <thead>
          <tr><th>{{ th_date }}</th><th>{{ th_desc }}</th><th>{{ th_amount }}</th><th>{{ th_status }}</th><th>{{ th_pdf }}</th></tr>
        </thead>
        <tbody>
        {% for inv in invoices %}
          <tr>
            <td>{{ inv.date }}</td>
            <td>{{ inv.description }}</td>
            <td>{{ inv.amount }}</td>
            <td>{% if inv.status == 'Bezahlt' %}<span class="badge success">{{ st_paid }}</span>{% else %}<span class="badge warn">{{ st_open }}</span>{% endif %}</td>
            <td><a href="{{ inv.download_url }}" class="pdf-link">PDF</a></td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="info-text italic">{{ b_no_invoices }}</p>
    {% endif %}
  </div>
</section>

<style>
.qr-generator { max-width: 880px; margin: 0 auto; padding: 2rem 1rem; }
h1 { font-size: 2rem; margin-bottom: .5rem; }
.subtitle { margin-bottom: 1.5rem; color: #64748b; }
.status-badge { padding: .5rem .9rem; border-radius: 10px; display: inline-flex; align-items: center; gap: .4rem; margin-bottom: 1.5rem; font-weight: 600; }
.status-badge.success { background:#dcfce7; color:#15803d; }
.status-badge.danger  { background:#fee2e2; color:#b91c1c; }
.status-badge.warn    { background:#fef9c3; color:#854d0e; }
.qr-form { background: #fff; border: 1px solid #e2e8f0; border-radius: 16px; padding: 1.6rem; margin-bottom: 2rem; box-shadow: 0 3px 8px rgba(0,0,0,.05); }
.form-title { font-size: 1.25rem; font-weight: 700; color: var(--primary); margin-bottom: 1rem; }
.plan-wrapper { display:flex; justify-content:space-between; gap:1rem; }
.plan-name { font-size:1.6rem; font-weight:700; color: var(--primary); }
.plan-price { font-weight: 600; margin-bottom:.6rem; }
.btn-column a { display:block; margin-bottom:.4rem; }
.btn-primary { background: var(--accent); padding:.55rem 1rem; color:#fff; border-radius:10px; text-align:center; font-weight:600; display:inline-block; text-decoration:none; }
.btn-outline-success { border:1px solid #16a34a; padding:.55rem 1rem; border-radius:10px; color:#15803d; display:inline-block; text-decoration:none; }
.btn-outline-danger { border:1px solid #dc2626; padding:.55rem 1rem; border-radius:10px; color:#b91c1c; display:inline-block; text-decoration:none; }
.tariff-grid { display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
.tariff-card { background:#fff; border:1px solid #e2e8f0; border-radius:16px; padding:1.2rem; box-shadow:0 6px 18px rgba(0,0,0,.06); }
.tariff-card.active { outline:3px solid rgba(37,99,235,.6); }
.tariff-card h3 { font-size:1.25rem; font-weight:700; text-align:center; margin-bottom:.4rem; }
.tariff-card .price { font-size:1rem; font-weight:700; color:#1d4ed8; text-align:center; margin-bottom:.6rem; }
.tariff-card ul { margin:0; padding-left:1rem; }
.tariff-card ul li { margin:.35rem 0; }
.badge { padding:.2rem .5rem; border-radius:6px; font-weight:700; font-size:.8rem; }
.badge.success { background:#dcfce7; color:#166534; }
.badge.warn { background:#fef3c7; color:#92400e; }
.billing-table { width:100%; border-collapse:collapse; }
.billing-table th { background:#f1f5f9; font-weight:700; }
.billing-table th, .billing-table td { padding:.6rem; border-bottom:1px solid #e5e7eb; }
.pdf-link { color:var(--accent); }
.alert { margin-bottom:.8rem; padding:.65rem .8rem; border-radius:10px; font-weight:600; }
.alert.success { background:#dcfce7; color:#15803d; }
.alert.warn { background:#fef9c3; color:#854d0e; }
.alert.error { background:#fee2e2; color:#b91c1c; }
.alert.info { background:#dbeafe; color:#1d4ed8; }
@media (max-width: 900px) { .tariff-grid { grid-template-columns:1fr; } .plan-wrapper { flex-direction:column; } }
</style>
{% endblock %}
